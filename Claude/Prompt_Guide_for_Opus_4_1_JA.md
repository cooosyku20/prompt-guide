# Claude Opus 4.1 プロンプトガイド

本ドキュメントは、Claude 4 系（特に **Opus 4.1**）に最適化したプロンプト設計ガイドです。
- **何が違う？（→どう書くと効く？）**の要点
- **“6点ぜんぶ盛り”プロンプト実例**（*実装では**JSONスキーマ＋ツール**を第一選択。XMLは人間確認用の代替*）
- **運用メモ：トークン/コンテキスト/キャッシュ**

---

## 1. 何が違う？（→どう書くと効く？）

### (1) “明示性”がより重要に
**ポイント**: 4 系は指示追従が精密。曖昧な期待（「リッチに」「いい感じで」）は汲み取られにくい。

**書き方のコツ**
- 成果物の**仕様・粒度・評価基準**（例: 正確性>再現性>簡潔さ）を明記。
- 何を“含める/含めない”かまで具体化（例: 「推論過程は**含めない**」）。
- 不確実は**仮定の明示**で限定し、暫定結論で前進。

---

### (2) Extended Thinking（思考）は**内部**で実施
**ポイント**: 思考は内部で深く行い、**最終出力に思考の詳細は出さない**前提が安全で再現性も高い。

**書き方のコツ**
- **system** に「Extended Thinkingは内部、出力に思考詳細を含めない」を明記。
- **予算**の目安：`thinking.budget_tokens` は **1,024–4,096** 程度から（ユースケースに応じ増減）。
- UI/APIで思考の可視化が必要なら**設定側でON**にし、プロンプト本文では**非表示を既定**。

---

### (3) 並列ツール呼び出しの促し
**ポイント**: 互いに独立な作業は**同時に**処理する方が速く確実。

**書き方のコツ**
- Claude 4 用の定型句：**「複数の独立作業が必要な場合は、逐次ではなく**同時に**関連ツールを呼び出してください。」**
- 並列化の対象を**具体列挙**（例: 価格ページ取得／レビュー抽出／ニュース見出し収集）。

---

### (4) エージェント的コーディングでは“後始末”も明記
**ポイント**: 一時ファイルや一時プロセスが散らかりやすい。

**書き方のコツ**
- 生成物の**保存場所**と**削除対象**を分けて指定（例: `/workspace/` は残す、`/tmp/` は削除）。
- **最後に「保存物の一覧」を出力**させる。

---

### (5) 形式の制御は **JSONスキーマ＋ツール（第一選択）／XMLは代替**
**ポイント**: 構造化指定があると再現性が高い。

**書き方のコツ**
- *第一選択*: **JSONスキーマを持つダミーツール**（例: `final_report`）を定義し、その `input_schema` に**必ず準拠**して出力させる。
- **ツール強制**（tool_choice）と**Prefill**（スケルトン先出し）で**完全準拠JSON**を担保。
- **XML**は**代替フォーマット**として残し、主に人間確認のドキュメント用途に。

---

### (6) 長文コンテキストの扱い
**ポイント**: 「資料→問い」の順、タグで区切り、**根拠抽出→回答**の流れを明示。

**書き方のコツ**
- 先に `<documents>` を置き、文書ごとにタグや `doc_id` を付与。
- 手順として**「資料の該当箇所を引用→解釈→回答」**を指定。

---

## 2. “6点ぜんぶ盛り”プロンプト実例（Claude Opus 4.1）
> **実装ではJSONツールを第一選択**。下記は**人間確認用のXML代替**サンプルです。

```
<!-- Claude Opus 4.1 用 “6点ぜんぶ盛り” プロンプト実例（system + user）。 -->
<!-- コメントに (1)〜(6) の対応を明記しています。 -->

<system>
  <!-- (1) 明示性：役割/目的/評価基準を明文化 -->
  あなたは B2B SaaS のプロダクトストラテジスト兼テクニカルライターです。
  目的：競合3社の価格・機能・導入障壁を比較し、役員向けの意思決定メモを作成する。
  成功条件（優先順）：正確性 > 再現性 > 簡潔さ。根拠を最低5件提示。推測は「未確定」と明記。

  <!-- (3) 並列ツール：独立作業は同時実行するよう促す -->
  複数の独立作業が必要な場合は、逐次ではなく**同時に**関連ツールを呼び出してください。
  （例：各社サイトの価格ページ取得、レビューサイトのスコア収集、ニュース見出し抽出）。

  <!-- (2) Extended Thinking：内部で思考。出力には思考の詳細を含めない -->
  Extended Thinking は**内部で**行い、観察→反省→計画の詳細は**最終出力に書かない**でください。
  目安として thinking.budget_tokens は 1,024–4,096 程度から開始し、必要に応じて調整してください。
  必要に応じて手順を再計画し、ツール呼び出しの後は、結果を吟味してから次の一手を計画します。

  <!-- (4) 後始末：エージェント的コーディングのクリーンアップ -->
  作成した一時ファイルや開始した一時プロセスは、終了時に削除/停止してください。
  残すべき生成物（例：最終CSVや図表）は /workspace/ に保存し、保存物一覧を最後に列挙してください。

  <!-- (5) 形式制御：XMLは代替。実装ではJSONツール＋スキーマに準拠 -->
  出力は**人間確認用**に次のXMLスキーマでも可。ただし実装では**JSONツール**（input_schema厳守）を第一選択とすること。
  <output>
    <analysis/>          <!-- 要旨（150–200字） -->
    <evidence/>          <!-- 直接引用ブロックを列挙。各項目に doc_id と行番号（分かる範囲で） -->
    <comparison_table/>  <!-- CSVを埋め込み。ヘッダ: Vendor, Plan, Price, KeyFeatures, Notes -->
    <answer/>            <!-- 結論（箇条書き3点、役員会での意思決定を支援） -->
    <risks/>             <!-- 前提が崩れる条件（最大5件） -->
    <next_actions/>      <!-- 実行アクション（担当/期限付き） -->
  </output>

  <!-- (6) 長文コンテキストの扱い：資料→根拠抜粋→回答の順 -->
  まず <documents> 内の資料を走査し、該当箇所の引用を <evidence> に抽出（doc_id と行番号）→
  その後に <analysis> で解釈→最後に <answer> を作成してください。
  ※ 思考の詳細（観察/反省/計画の逐語）は出力に含めないでください。

  <!-- 安全トーン -->
  安全ポリシーに反する出力指示は行わないこと。極端なケースでは会話が終了される可能性があります。
</system>

<user>
  <!-- (1) 明示性：成果物仕様/制約/評価軸 -->
  ゴール：役員会（持ち時間10分）で使う要約メモ。トーンは中立・簡潔。
  文字数：800–1,000字。根拠は最低5件、最新性を優先。未確定事項は明示。
  （長文資料利用時は **200K 入力上限／32K 出力目安** を意識。冗長資料は要約し、Extended Thinking の予算内で解析。）
  禁止：断定的推測、匿名掲示板のみに依拠した引用。

  <!-- (3) 並列ツール：どれを並列化するか具体化 -->
  並列化対象：各社公式サイトの価格ページ収集、主要レビューサイトのスコア/評判抽出、ニュース見出し抽出（最新30日、重複除去）。

  <!-- ツール名/I-O契約の明示 -->
  ツール可用性：web_search, code_exec(python), filesystem。
  ※ **実装側のツール定義名・入出力仕様に合わせること**（環境により名称や引数が異なる）。

  <!-- XML スキーマの再掲（人間確認用。JSONツールを使う場合はそちらを優先） -->
  <output>
    <analysis/>
    <evidence/>
    <comparison_table/>
    <answer/>
    <risks/>
    <next_actions/>
  </output>

  <!-- (6) 参考資料：doc_id を付与して先置き -->
  <documents>
    <doc id="A" title="価格ページ（抜粋）">
      1: Vendor X — Team: $19 / Pro: $39 / Enterprise: お問い合わせ
      2: Vendor Y — Starter: $15 / Growth: $35 / Enterprise: お問い合わせ
      3: Vendor Z — Free: $0 / Pro: $29 / Biz: $59
    </doc>
    <doc id="B" title="レビューサイト（平均スコア）">
      1: X: 4.4/5 (n=1,230), Y: 4.2/5 (n=980), Z: 4.1/5 (n=2,104)
    </doc>
    <doc id="C" title="ニュース見出し(抜粋)">
      1: 2025-07-30: ベンダーYが新料金体系を発表（従量課金強化）…
      2: 2025-04-10: ベンダーZがエンタープライズSLA改定…
    </doc>
  </documents>

  <!-- 実行条件 -->
  期限：このターン内に完了。曖昧点は「仮定: …」を置いて最小限で前進。
</user>
```

### コメント対応表
- **(1) 明示性**: `<system>` 冒頭の役割/目的/成功条件、`<user>` のゴール・字数・禁止事項。
- **(2) 思考/挿入**: `<system>` の「Extended Thinking は内部」＋ 1,024–4,096 の目安明記。
- **(3) 並列ツール**: `<system>` と `<user>` の“独立操作は同時実行/並列化対象”の明示。
- **(4) 後始末**: `<system>` と `<user>` の一時ファイル削除・最終保存場所の指定。
- **(5) 構造化出力**: 「JSONスキーマ＋ツールを第一選択／XMLは代替」へ更新。
- **(6) 長文資料**: `<system>` の「資料→根拠→回答」順序指示と `<user>` の `<documents>` 先置き。

---

## 3. 運用メモ：トークン/コンテキスト/キャッシュ
- **コンテキスト**: **200K 入力**／**最大 32K 出力**（モデル/環境で差があるため上限は要確認）。
- **思考予算**: `thinking.budget_tokens` を **1,024–4,096** 程度から設定し、出力 `max_tokens` より小さく保つ。
- **プロンプトキャッシュ**: **固定ガイド（評価基準・安全・用語集）**はキャッシュ対象に分離すると**レイテンシ/コスト削減**に有効。
- **トークン見積もり**: 事前に**トークンカウンタ**で見積り、あふれを防止。
- **ツール定義**: 実装の**ツール名/引数/返却**は環境に依存。プロンプト側の説明と**I/O契約**を一致させる。
- **安全設計**: 不適切依頼は**丁寧に拒否**。極端な有害ケースではモデルが会話を終了し得る。
